<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mocha</title>
    <link rel="stylesheet" type="text/css" href="../../node_modules/mocha/mocha.css">
  </head>
  <body>
    <div id="mocha"></div>
    <script src="../../node_modules/mocha/mocha.js"></script>
    <script src="../../node_modules/chai/chai.js"></script>
    <script src="../../node_modules/chai-as-promised/lib/chai-as-promised.js"></script>
    <script>
      // Track fetch() calls to ensure that none are left running from a
      // previous test before the subsequent test begins.  This makes the suite
      // more reliable on Webkit, where tests were otherwise failing due to
      // hanging requests caused by too many simultaneous requests to the same
      // domain (the couchdb/pouchdb-server).

      // TODO consider moving this code to testUtils or similar to:
      // * allow re-use in other integration tests
      // * make sure it's linted

      let fetches = [];

      const originalFetch = fetch;
      fetch = async (...args) => {
        let controller;
        if (args.length === 2) {
          const options = args[1];
          controller = options._abortController;
          delete options._abortController;
        }
        const log = { stack:new Error().stack, args, controller, done:false };
        fetches.push(log);
        try {
          return await originalFetch(...args);
        } finally {
          log.done = true;
        }
      };

      mocha.setup({
        timeout: 20_000,
        ui: 'bdd',
      });
      var should = chai.should();
      var assert = chai.assert;

      let testTimeout;

      function showOpenConnections() {
        console.log('showOpenConnections()', 'Test has nearly timed out; perhaps there is a pending fetch:');
        for(let f of fetches) {
          console.log('showOpenConnections()', '   *', JSON.stringify(f, null, 2));
          if (!f.done && typeof f.controller !== 'string') {
            console.log('showOpenConnections()', '   -> aborting...');
            f.controller.abort();
          }
        }
      }

      beforeEach(() => {
        fetches = [];
        testTimeout = setTimeout(showOpenConnections, 15_000);
      });

      afterEach(function (done) {
        clearTimeout(testTimeout);
        if (fetches.every(f => f.done)) {
          return done();
        }
        setTimeout(() => {
          const unfinished = fetches.filter(f => !f.done);
          if(unfinished.length) {
            console.log('afterEach()', this.test.title, 'unfinished:', unfinished.length);
            for(let f of fetches) {
              console.log('afterEach()', this.test.title, '   *', JSON.stringify(f, null, 2));
            }
            //done(new Error(`Pending fetches after test complete: ${this.test.title} ${JSON.stringify(unfinished)}`));
            done(); // For now, just warn when there are open connections
          } else {
            done();
          }
        }, 1000); // TODO consider trying smaller timeouts
      });

      after(() => console.log('after() called!'));
    </script>
    <script src='utils-bundle.js'></script>
    <script src='test.setup_global_hooks.js'></script>
    <script src='test.aa.setup.js'></script>
    <script src='test.basics.js'></script>
    <script src='test.constructor.js'></script>
    <script src='test.changes.js'></script>
    <script src='test.bulk_docs.js'></script>
    <script src='test.bulk_get.js'></script>
    <script src='test.all_docs.js'></script>
    <script src='test.events.js'></script>
    <script src='test.conflicts.js'></script>
    <script src='test.revs_diff.js'></script>
    <script src='test.replication.js'></script>
    <script src='test.replication_events.js'></script>
    <script src='test.sync.js'></script>
    <script src='test.sync_events.js'></script>
    <script src='test.retry.js'></script>
    <script src='test.taskqueue.js'></script>
    <script src='test.design_docs.js'></script>
    <script src='browser.info.js'></script>
    <script src='test.issue221.js'></script>
    <script src='test.issue2674.js'></script>
    <script src='test.issue3179.js'></script>
    <script src='test.issue3646.js'></script>
    <script src='test.issue8581.js'></script>
    <script src='test.http.js'></script>
    <script src='test.compaction.js'></script>
    <script src='test.get.js'></script>
    <script src='test.local_docs.js'></script>
    <script src='test.attachments.js'></script>
    <script src='browser.migration.js'></script>
    <script src='test.uuids.js'></script>
    <script src='test.slash_id.js'></script>
    <script src='test.reserved.js'></script>
    <script src='test.prefix.js'></script>
    <script src='test.deterministicrevs.js'></script>
    <script src='test.viewadapter.js'></script>
    <script src='browser.worker.js'></script>
    <script type="text/javascript" src="./webrunner.js"></script>
  </body>
</html>
